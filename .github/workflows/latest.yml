name: Bandit Scan

on: 
  push:
    branches:
      - master

jobs:
  Bandit:
    name: Bandit Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v2

      - name: Security check - Bandit
        uses: ioggstream/bandit-report-artifacts@v0.0.2
        with:
          project_path: .
          ignore_failure: true

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tabulate

      - name: Extract Bandit Issues
        id: extract-issues
        run: |
          import re

          with open('output/security_report.txt', 'r') as report_file:
              report_content = report_file.read()

          issues = re.findall(r'Issue: \[.*?\]\n(.*?)[\n\n]', report_content, re.DOTALL)

          with open('output/issues.txt', 'w') as issues_file:
              for issue in issues:
                  issues_file.write(issue.strip() + '\n---\n')

      - name: Display Issues
        run: |
          import os
          from tabulate import tabulate

          with open('output/issues.txt', 'r') as issues_file:
              issues_content = issues_file.read()

          issues_list = issues_content.strip().split('\n---\n')

          data = []
          for issue in issues_list:
              issue_data = {}
              lines = issue.split('\n')
              for line in lines:
                  key, value = line.strip().split(': ', 1)
                  issue_data[key] = value
              data.append(issue_data)

          headers = list(data[0].keys()) if data else []

          print(tabulate(data, headers=headers, tablefmt="pipe"))

          if any(issue['Severity'] == 'High' for issue in data):
              print("Check the code for the correction of security risk.")
              os._exit(1)
